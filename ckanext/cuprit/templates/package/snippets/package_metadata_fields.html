{% ckan_extends %}

{% block package_metadata_author %}
</fieldset>
<script src="/js/vue.global.prod.min.js"></script>
<script>const { createApp } = Vue;</script>

<fieldset>
  <legend>Responsibilities</legend>
  <div class="no-margin-bottom">
    {{ form.input('author', label=_('Author(s)'), id='field-author', placeholder=_('Firstname Lastname of author'), value=data.author, error=errors.author, classes=['control-medium']) }}
  </div>
  <input id="a_holder" value="{{data.author}}" class="hidden" style="height: 1px">
  <div id="author_widget">
    <div v-for="(item, index) in authors" :key="index" class="author-block">
      <!-- Author Name Label -->
      <label for="author-name-{{index}}" class="form-label mb-0 mt-2 fw-normal">Author Name</label>
      <input type="text" v-model="item.name" id="author-name-{{index}}" class="form-control control-medium" placeholder="Firstname Lastname">
  
      <!-- ORCID Label -->
      <label for="author-orcid-{{index}}" class="form-label mb-0 mt-2 fw-normal">ORCID</label>
      <input type="text" v-model="item.tempOrcid" @keyup="validateAndUpdateAuthor(index, 'orcid', item.tempOrcid)" id="author-orcid-{{index}}" class="form-control dataset_dynamic_input" placeholder="Format: 0000-1111-2222-3333">
      
      <!-- RORID Label -->
      <label for="author-rorid-{{index}}" class="form-label mb-0 mt-2 fw-normal">RORID</label>
      <input type="text" v-model="item.tempRorid" @keyup="validateAndUpdateAuthor(index, 'rorid', item.tempRorid)" id="author-rorid-{{index}}" class="form-control dataset_dynamic_input" placeholder="Format: 041qv0h25">
      
      <a @click="removeAuthor(index)" style="cursor: pointer;" class="mt-3 text-end text-danger d-block">remove</a>
    </div>
    <button @click.prevent="addNewAuthor" class="btn btn-primary btn-sm" style="transform: translateY(-2px); margin-top: 10px;">Add Author</button>
  </div>
  
  <script>
  document.getElementById("field-author").readOnly = true;
  createApp({
    data() {
      return {
        authors: [],
      }
    },
    mounted() {
      const data = document.getElementById("a_holder").value;
      this.authors = data.split(';').filter(item => item).map(author => {
        const parts = author.split(/[\[\]()]/).filter(part => part.trim());
        let name = parts[0].trim();
        let orcid = parts[1]?.trim() || '';
        let rorid = parts[2]?.trim() || '';
        return { name, orcid, rorid, tempOrcid: orcid, tempRorid: rorid };
      });
    },
    methods: {
      addNewAuthor() {
        this.authors.push({ name: '', orcid: '', rorid: '', tempOrcid: '', tempRorid: '' });
      },
      removeAuthor(index) {
        this.authors.splice(index, 1);
      },
      validateAndUpdateAuthor(index, field, value) {
        // Validation logic here
        if (value === '') {
          this.authors[index][field] = '';
          this.authors[index]['temp' + field.charAt(0).toUpperCase() + field.slice(1)] = '';
        } else {
          let isValid = (field === 'orcid') ? this.validateOrcid(value) : this.validateRorid(value);
          if (isValid) {
            this.authors[index][field] = value;
          }
        }
        this.updateHiddenInputs();
      },
      updateHiddenInputs() {
        // Update logic here
        document.getElementById("field-author").value = this.authors.map(author => {
          let formatted = author.name;
          if (author.orcid) formatted += ` (${author.orcid})`;
          if (author.rorid) formatted += ` [${author.rorid}]`;
          return formatted;
        }).join('; ');
      },
      validateOrcid(orcid) {
        const regex = /^\d{4}-\d{4}-\d{4}-\d{4}$/;
        return regex.test(orcid);
      },
      validateRorid(rorid) {
        const regex = /^[0-9a-zA-Z]+$/;
        return regex.test(rorid);
      },
    }
  }).mount('#author_widget');
  </script>
  

  <div class="no-margin-bottom">
    {{ form.input('contributor', label=_('Contributor'), id='field-contributor', placeholder=_('Firstname Lastname of person who contributed to this work'), value=data.contributor, error=errors.contributor, classes=['control-medium']) }}
  </div>
  
  <input id="c_holder" value="{{data.contributor}}" class="hidden" style="height: 1px">
  
  <div id="contributor_widget">
    <div v-for="(item, index) in contributors" :key="index" class="contributor-block">
      <!-- Name Label and Input -->
      <div class="row">
      <div class="col-md-8">
        <label for="name-{{index}}" class="form-label mb-0 mt-2 fw-normal">Name</label>
        <input type="text" v-model="item.name" id="name-{{index}}" class="form-control control-medium" placeholder="Firstname Lastname">
      </div>
    
      <!-- Type Select Field -->
      <div class="col-md-4">
        <label for="type-{{index}}" class="form-label mb-0 mt-2 fw-normal">Type</label>
        <select v-model="item.tempType" @change="validateAndUpdateContributor(index, 'type', item.tempType)" id="type-{{index}}" class="form-control control-medium">
          <option value="ContactPerson">ContactPerson</option>
          <option value="DataCollector">DataCollector</option>
          <option value="DataCurator">DataCurator</option>
          <option value="DataManager">DataManager</option>
          <option value="Distributor">Distributor</option>
          <option value="Editor">Editor</option>
          <option value="HostingInstitution">HostingInstitution</option>
          <option value="Producer">Producer</option>
          <option value="ProjectLeader">ProjectLeader</option>
          <option value="ProjectManager">ProjectManager</option>
          <option value="ProjectMember">ProjectMember</option>
          <option value="RegistrationAgency">RegistrationAgency</option>
          <option value="RegistrationAuthority">RegistrationAuthority</option>
          <option value="RelatedPerson">RelatedPerson</option>
          <option value="Researcher">Researcher</option>
          <option value="ResearchGroup">ResearchGroup</option>
          <option value="RightsHolder">RightsHolder</option>
          <option value="Sponsor">Sponsor</option>
          <option value="Supervisor">Supervisor</option>
          <option value="WorkPackageLeader">WorkPackageLeader</option>
          <option value="Other">Other</option>
        </select>
      </div>
    </div>
      <!-- ORCID Label and Input -->
      <div class="col-md-12">
        <label for="orcid-{{index}}" class="form-label mb-0 mt-2 fw-normal">ORCID ID</label>
        <input type="text" v-model="item.tempOrcid" @keyup="validateAndUpdateContributor(index, 'orcid', item.tempOrcid)" id="orcid-{{index}}" class="form-control dataset_dynamic_input" placeholder="Format: 0000-1111-2222-3333">
      </div>

      <!-- RORID Label and Input -->
      <div class="col-md-12">
        <label for="rorid-{{index}}" class="form-label mb-0 mt-2 fw-normal">ROR ID</label>
        <input type="text" v-model="item.tempRorid" @keyup="validateAndUpdateContributor(index, 'rorid', item.tempRorid)" id="rorid-{{index}}" class="form-control dataset_dynamic_input" placeholder="Format: 041qv0h25">
      </div>
  
      <a @click="removeContributor(index)" style="cursor: pointer;" class="mt-3 text-end text-danger d-block">remove</a>
    </div>
    
    <button @click.prevent="addNewContributor" class="btn btn-primary btn-sm" style="transform: translateY(-2px); margin-top: 10px;">Add Contributor</button>
  </div>
  
  <script>
    document.getElementById("field-contributor").readOnly = true;
    createApp({
      data() {
        return {
          contributors: [],
        }
      },
      mounted() {
        const data = document.getElementById("c_holder").value;
        this.contributors = data.split(';').filter(item => item).map(contributor => {
          const parts = contributor.split(/[\[\]{}()]/).filter(part => part.trim());
          let name = parts[0].trim();
          let orcid = parts[1]?.trim() || '';
          let rorid = parts[2]?.trim() || '';
          let type = parts[3]?.trim() || 'Researcher'; // Default to Researcher if not specified

          return { name, orcid, rorid, tempOrcid: orcid, tempRorid: rorid, tempType: type };
        });
      },
      methods: {
        addNewContributor() {
          this.contributors.push({ name: '', orcid: '', rorid: '', tempOrcid: '', tempRorid: '', tempType: 'Researcher' }); // Include type
        },
        removeContributor(index) {
          this.contributors.splice(index, 1);
        },
        validateAndUpdateContributor(index, field, value) {
          if (value === '') {
            this.contributors[index][field] = '';
            this.contributors[index]['temp' + field.charAt(0).toUpperCase() + field.slice(1)] = '';
          } else {
            let isValid = true;
            if (field === 'orcid') {
              isValid = this.validateOrcid(value);
            } else if (field === 'rorid') {
              isValid = this.validateRorid(value);
            } // No else, type does not need validation
  
            if (isValid) {
              this.contributors[index][field] = value;
            }
          }
          this.updateHiddenInputs();
        },
        updateHiddenInputs() {
          const formattedContributors = this.contributors.map(item => {
            let formattedName = item.name;
            if (item.orcid && this.validateOrcid(item.orcid)) {
              formattedName += ` (${item.orcid})`;
            }
            if (item.rorid && this.validateRorid(item.rorid)) {
              formattedName += ` [${item.rorid}]`;
            }
            if (item.tempType) {
              formattedName += ` {${item.tempType}}`; // Format type
            }
            return formattedName;
          }).join('; ');
          document.getElementById("c_holder").value = formattedContributors;
          document.getElementById("field-contributor").value = formattedContributors;
        },
        validateOrcid(orcid) {
          const regex = /^\d{4}-\d{4}-\d{4}-\d{4}$/;
          return regex.test(orcid);
        },
        validateRorid(rorid) {
          const regex = /^[0-9a-zA-Z]+$/;
          return regex.test(rorid);
        },
      }
    }).mount('#contributor_widget');
  </script>
  
    
    {% endblock %}

    {% block package_metadata_fields_maintainer %}

    {{ form.input('maintainer', label=_('Maintainer'), id='field-maintainer', placeholder=_('Firstname Lastname of person that maintains this dataset'), value=data.maintainer, error=errors.maintainer, classes=['control-medium']) }}

      {{ form.input('maintainer_email', label=_('Maintainer Email'), id='field-maintainer-email', placeholder=_('max.mustermannk@dainst.de (currently only one E-mail address supported!)'), value=data.maintainer_email, error=errors.maintainer_email, classes=['control-medium']) }}
      <span class="ds_notes" style="transform: translateY(-30px);">This E-Mail will be used to contact the person who is responsible for the dataset.</span>

    {% endblock %}

    {% block custom_fields %}
    {{ form.input('publisher', label=_('Publisher'), id='field-publisher', placeholder=_('Deutsches Archäologisches Institut'), value=(data.publisher if data.publisher else _('Deutsches Archäologisches Institut')), error=errors.publisher, classes=['control-medium']) }}
    {{ form.checkbox('agree', label=_('I have read and agree to the <a href="/help" target="blank">terms of service</a>.'), id='agree', value='1' if data.agree else '0', error=errors.agree, is_required=true) }}
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {

            agr = jQuery("#agree");
            if (agr.val() == '1') { agr.prop('checked', true) }

            jQuery(document).on("submit", "form", function(e) {
                if (!agr.prop('checked')) {
                    e.preventDefault();
                    jQuery("label.checkbox").append('<span id="agree_warning" class="control-required">Please agree to the terms of service.</span>')
                    alert('Please agree to the terms of service.');
                    return false;
                }
            });

            jQuery(document).on("click", agr, function(e) {
                if (agr.prop('checked')) {
                    $("button[name='save']").attr('disabled', false);
                    agr.val('1')
                } else {
                    agr.val('0')
                }
            });

            $('.js-example-basic-multiple').select2();

        });
    </script>

</fieldset>


{% endblock %}

{% block package_metadata_fields_url %}
{% endblock %}
{% block package_metadata_fields_version %}
{% endblock %}

